<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.10">
<title>Developer Documentation</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Developer Documentation</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_general_design_principles">1. General Design Principles</a>
<ul class="sectlevel2">
<li><a href="#_layers">1.1. Layers</a></li>
<li><a href="#_resource_id_as_uuid">1.2. Resource Id as UUID</a></li>
<li><a href="#_inter_module_foreign_keys">1.3. Inter-module foreign keys</a></li>
<li><a href="#_inter_module_communication">1.4. Inter-module communication</a></li>
</ul>
</li>
<li><a href="#_design_and_implementation_considerations">2. Design and Implementation Considerations</a>
<ul class="sectlevel3">
<li><a href="#_spring_di">2.1. Spring DI</a></li>
<li><a href="#_use_of_dtos">2.2. Use of DTOs</a></li>
<li><a href="#_domain_objectentity">2.3. Domain Object/Entity</a></li>
<li><a href="#_always_valid_entity">2.4. Always-Valid Entity</a></li>
<li><a href="#_validation_general_principles">2.5. Validation: General Principles</a></li>
</ul>
</li>
<li><a href="#_test_support">3. Test Support</a>
<ul class="sectlevel2">
<li><a href="#_running_integration_tests_against_a_postgres_docker_container_using_postgrestestcontainerinitializer">3.1. Running integration tests against a Postgres Docker container using PostgresTestContainerInitializer</a></li>
<li><a href="#_openapi3assertions">3.2. OpenAPI3Assertions</a></li>
<li><a href="#_mock_keycloak_user">3.3. Mock Keycloak User</a></li>
</ul>
</li>
<li><a href="#_testing">4. Testing</a>
<ul class="sectlevel2">
<li><a href="#_unit_tests">4.1. Unit Tests</a></li>
<li><a href="#_integration_tests">4.2. Integration Tests</a></li>
</ul>
</li>
<li><a href="#_authentication">5. Authentication</a>
<ul class="sectlevel2">
<li><a href="#_getting_the_current_user">5.1. Getting the current user</a></li>
<li><a href="#_using_a_dev_mode_user_without_needing_to_authenticate_manually">5.2. Using a dev-mode user without needing to authenticate manually</a></li>
</ul>
</li>
<li><a href="#_setting_up_your_dina_repo_for_authorization">6. Setting up your Dina Repo for authorization</a>
<ul class="sectlevel2">
<li><a href="#_overview">6.1. Overview</a></li>
<li><a href="#_step_by_step_using_a_custom_dina_authorization_service">6.2. Step by Step: Using a custom Dina Authorization Service</a></li>
<li><a href="#_returning_your_permissions_for_an_object">6.3. Returning your permissions for an object</a></li>
</ul>
</li>
<li><a href="#_cors_cross_origin_resource_sharing">7. CORS: Cross-Origin Resource Sharing</a>
<ul class="sectlevel2">
<li><a href="#_enabling_cors">7.1. Enabling CORS</a></li>
</ul>
</li>
<li><a href="#_filtering">8. Filtering</a></li>
<li><a href="#_actuators">9. Actuators</a></li>
<li><a href="#_messaging">10. Messaging</a>
<ul class="sectlevel2">
<li><a href="#_message_procucer">10.1. Message procucer</a></li>
<li><a href="#_message_consumer">10.2. Message consumer</a></li>
</ul>
</li>
<li><a href="#_validation">11. Validation</a>
<ul class="sectlevel2">
<li><a href="#_the_principles">11.1. The Principles</a></li>
<li><a href="#_implementation">11.2. Implementation</a></li>
</ul>
</li>
<li><a href="#_validation_endpoint">12. Validation Endpoint</a>
<ul class="sectlevel2">
<li><a href="#_set_the_configuration_properties">12.1. Set the configuration properties</a></li>
<li><a href="#_create_a_validation_resource_configuration">12.2. Create a Validation Resource Configuration</a></li>
<li><a href="#_using_the_endpoint">12.3. Using the Endpoint</a></li>
</ul>
</li>
<li><a href="#_auditing">13. Auditing</a>
<ul class="sectlevel2">
<li><a href="#_setting_up_your_dina_repo_for_auditing">13.1. Setting up your Dina Repo for auditing</a></li>
<li><a href="#_prepare_your_dto">13.2. Prepare your DTO</a></li>
<li><a href="#_pass_the_auditing_service_bean_to_your_dina_repo">13.3. Pass the Auditing service bean to your Dina repo</a></li>
<li><a href="#_accessing_the_auditing_endpoint">13.4. Accessing the Auditing Endpoint</a></li>
</ul>
</li>
<li><a href="#_lazy_logging">14. Lazy Logging</a></li>
<li><a href="#_external_types_guide">15. External Types Guide</a>
<ul class="sectlevel2">
<li><a href="#_set_up_your_entity">15.1. Set up your entity</a></li>
<li><a href="#_set_up_your_dto">15.2. Set up your DTO</a></li>
<li><a href="#_set_up_your_external_resource_provider_component">15.3. Set up your External Resource Provider Component</a></li>
</ul>
</li>
<li><a href="#_releasing_dina_base_api">16. Releasing dina-base-api</a></li>
<li><a href="#_field_adapters">17. Field adapters</a>
<ul class="sectlevel2">
<li><a href="#_implement_a_dina_field_adapter_for_the_field">17.1. Implement a Dina Field Adapter for the field.</a></li>
<li><a href="#_annotate_your_field_with_ignoredinamapping">17.2. Annotate your field with IgnoreDinaMapping</a></li>
<li><a href="#_annotate_your_class_with_customfieldadapter">17.3. Annotate your class with CustomFieldAdapter</a></li>
</ul>
</li>
<li><a href="#_custom_rsql_filtering">18. Custom Rsql Filtering</a>
<ul class="sectlevel2">
<li><a href="#_current_specs">18.1. Current Specs</a></li>
</ul>
</li>
<li><a href="#_one_to_many_associations">19. One to Many Associations</a>
<ul class="sectlevel2">
<li><a href="#_using_the_onetomanydinaservice">19.1. Using the OneToManyDinaService</a></li>
<li><a href="#_using_onetomanyfieldhandler_directly">19.2. Using OneToManyFieldHandler directly</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_general_design_principles">1. General Design Principles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>General design principles applicable on all DINA modules.</p>
</div>
<div class="sect2">
<h3 id="_layers">1.1. Layers</h3>
<div class="paragraph">
<p>The targeted architecture is a based on a 3-layer architecture. Communication between layers would be done using DTOs (Data Transfer Objects) or Entities depending on the layer.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/svg.png" alt="svg" width="175" height="332">
</div>
</div>
<div class="sect3">
<h4 id="_repository_layer">1.1.1. Repository Layer</h4>
<div class="ulist">
<ul>
<li>
<p>Tightly coupled to the service and mapping layer.</p>
</li>
<li>
<p>Communicates to the service layer for access to database resources but never contacts the database directly.</p>
</li>
<li>
<p>Communicates to the mapping layer to process entities into DTO&#8217;s and vise versa.</p>
</li>
<li>
<p>Processes incoming HTTP requests for the API endpoint to send the appropriate response.</p>
</li>
<li>
<p>Processing of incoming HTTP request is mostly handled automatically by the underlying Crnk framework. Crnk will process the incoming request and send it to the appropriate method while mapping the request body and parameters to the required method parameters.</p>
</li>
<li>
<p>The repository layer is where most of the Crnk related processing should happen for example processing the filters of the query spec.</p>
</li>
<li>
<p>Communication to the service layer is usually done through the use of entity classes, and communication to the HTTP layer is usually done through the use of DTO&#8217;s which have been mapped from their database backed entity representations.</p>
</li>
<li>
<p>Each repository requires a specific database service class implementation and a mapper.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_service_layer">1.1.2. Service Layer</h4>
<div class="ulist">
<ul>
<li>
<p>Mainly used for database access and entity processing before CREATE/UPDATE/DELETE operations.</p>
</li>
<li>
<p>Has methods that can be over ridden to inject business logic to process entities before CREATE/UPDATE/DELETE operations. Most notably the <code>preCreate preUpdate preDelete</code> methods.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">preCreate auto generate UUID on create</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Override
    protected void preCreate(Person entity) {
      entity.setUuid(UUID.randomUUID());
    }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Should be used for typical pre-persist, pre-update, and pre-delete operations when they can be applied.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_layer">1.1.3. Mapping Layer</h4>
<div class="paragraph">
<p>The Mapping Layer refers to layer that is responsible for mapping the values of a Resource between its entity and Dto class.</p>
</div>
<div class="paragraph">
<p>The Mapping Layer involves three main components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The DinaMappingRegistry which tracks all the needed information for a Resources domain</p>
</li>
<li>
<p>The DinaMappingLayer which is responsible for mapping a dto to an entity and vice versa using the mapping registry and the DinaMapper. The DinaMappingLayer is also responsible for handling external relations, and will link internal relations to database backed equivalents.</p>
</li>
<li>
<p>The DinaMapper which is responsible for recursive bean to bean mapping for the entire resource graph which can be extended to apply custom field mappings for specific fields.</p>
<div class="ulist">
<ul>
<li>
<p>Mapper has mechanisms in place to allow for the exclusion of fields and/or relationships during the mapping process.</p>
</li>
<li>
<p>Mappers should not communicate with the service layer to map relations directly.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/MappingOverview.svg" alt="MappingOverview" width="393" height="359">
</div>
<div class="title">Figure 1. Mapping Layer Overview</div>
</div>
</div>
<div class="sect3">
<h4 id="_mapping_layer_concepts">1.1.4. Mapping Layer concepts</h4>
<div class="paragraph">
<p>When mapping between an entity and a Dto, each field needs to transferred from one object to another. However, the values do not map directly.</p>
</div>
<div class="sect4">
<h5 id="_resource_graph">Resource Graph</h5>
<div class="paragraph">
<p>All of the attributes of a resource can be mapped directly however the resources associations with other resources must also be mapped between their own DTO/entity equivalents.</p>
</div>
<div class="paragraph">
<p>These associations are referred to as relations.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/SimpleMappingOperation.svg" alt="SimpleMappingOperation" width="822" height="301">
</div>
<div class="title">Figure 2. Simple Mapping Operation</div>
</div>
<div class="paragraph">
<p>You can visualize a resource and all of it&#8217;s associations as a graph.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="./images/ResourceGraphVisualization.svg" alt="ResourceGraphVisualization" width="235" height="336">
</div>
<div class="title">Figure 3. Resource Graph Visualization</div>
</div>
<div class="paragraph">
<p>If ResourceA has a ResourceB, ResourceB has a ResourceC, and ResourceC has a ResourceA, they each need to mapped appropriately when mapping ResourceA</p>
</div>
<div class="paragraph">
<p>The Mapping Layer needs to distinguish between relations and attributes when reading the associated java classes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_relation">Relation</h5>
<div class="ulist">
<ul>
<li>
<p>A relation is a field that is marked as a <code>@JsonApiRelation</code> on The DTO and is not marked with <code>@IgnoreDinaMapping</code>.</p>
</li>
<li>
<p>These fields are not mapped directly instead the values themselves must also be mapped and transferred.</p>
</li>
<li>
<p>A relation is considered internal unless marked with <code>@JsonApiExternalRelation</code>.</p>
</li>
<li>
<p>External relations represent an association with a resource in a separate module and will not be mapped to their database equivalent.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example Relations</div>
<div class="content">
<pre>  public static final class StudentDto { // DTO Class

    @JsonApiRelation // Maps to related entity
    private StudentDto normalRelation;

    // Maps to related entity, un marked
    private List&lt;TaskDTO&gt; anotherRelation;

    @JsonApiExternalRelation(type = "agent")
    @JsonApiRelation // External Relations always map between ExternalRelationDto and UUID
    private ExternalRelationDto externalRelation;

  }

  public static class Student { // Entity Class

    private Student normalRelation; // Maps to related entity

    private List&lt;Task&gt; anotherRelation; // Maps to related entity

    private UUID externalRelation; // External Relations maps to ExternalRelationDto/UUID
  }</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_attribute">Attribute</h5>
<div class="ulist">
<ul>
<li>
<p>An attribute is a field that is not <code>@IgnoreDinaMapping</code> or marked as a relation and will be mapped directly as a value.</p>
</li>
<li>
<p>An attribute must have the same data type on the DTO class and its related entity.</p>
</li>
<li>
<p>A field that is considered an attribute (Unmarked) but has a valid DTO/RelatedEntity mapping between the data types will be considered a relation.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Example Attribute</div>
<div class="content">
<pre>  public static final class StudentDto { // DTO Class

    private String name; // attribute, has same data type

  }

  public static class Student { // Entity Class

    private String name; // attribute, has same data type

  }</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_resource_id_as_uuid">1.2. Resource Id as UUID</h3>
<div class="paragraph">
<p>All database identifiers should be numerical based since it`s efficient and easier to manage at the database level. Even if there is no issue about leaking business information we will still expose UUID instead of the database key in the API. This will give us more flexibility at the database level while reducing potential issues with API users iterating over ids or using a wrong set of ids. Based on the “Inter-module foreign key” module, UUID’s will help detect wrong linkages by making it almost impossible to reuse a key of the wrong resource. Numerical id’s can be reused in different resources (even if this can be solved by using a global sequence) while UUID are more likely to be unique across the system.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inter_module_foreign_keys">1.3. Inter-module foreign keys</h3>
<div class="paragraph">
<p>To reduce referential integrity violation while maintaining the system simplicity and easy of use, the following rules should be applied:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Soft-delete only: entities should never be completely deleted. Instead, they should have a deletedDate property setting the date of deletion. Such entity should return a 410 Gone instead of a 404, with a body indicating how to access the deleted entity (e.g. sample/cf71a71e-2176-4d6f-9f17-a4c4f3dd104e?deleted=true)</p>
</li>
<li>
<p>Each modules should have an asynchronous job to report all external foreign key usage.</p>
</li>
<li>
<p>There is no enforcement on insert/update since services can not talk to another service to check if the key actually exists</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_inter_module_communication">1.4. Inter-module communication</h3>
<div class="paragraph">
<p>All inter-module communications are coordinated by the client (e.g. the integrated UI). In order to reduce coupling and increase maintainability, no modules are allowed to talk to each other directly. In the event where 2 modules shall communicate, a new “proxy” module should be created to orchestrate the communication but it should be avoided.
No distributed transactions mechanism will be implemented. Possible inconsistencies due to a “transaction” that would require 2 modules, where 1 is temporary down, are acceptable as long as there is a way to report them.</p>
</div>
<div class="paragraph">
<p>Pros:
* A module will not be able to take another one down
* Simpler module deployment and maintenance</p>
</div>
<div class="paragraph">
<p>Cons:
* No referential integrity enforcement on external foreign keys
* No direct feedback to the API user on a possible bad linking between 2 services</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_and_implementation_considerations">2. Design and Implementation Considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page should be interpreted as a guideline to achieve consistent and predictable design during the entire lifecycle of the application.
Some concepts are coming from the <a href="https://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> approach and it will also refer to the <a href="https://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">SOLID principles</a> to back some design decisions.</p>
</div>
<div class="paragraph">
<p>This page should not be considered a static set of rules. It will evolve over time as we iterate over the project. For all code produced, it should follow this guide or provide documentation explaining why. If the explanation can be generalized and the “concept” can be applied in the entire project this guide should be updated.</p>
</div>
<div class="sect3">
<h4 id="_spring_di">2.1. Spring DI</h4>
<div class="paragraph">
<p>Use constructor injection for all mandatory dependencies and ensure dependencies are marked as final. It will make the class more testable and also make sure that class can be used without Spring DI (as opposed to field injection).</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_of_dtos">2.2. Use of DTOs</h4>
<div class="paragraph">
<p>In order to detach the object exposed and the one that is stored we will use DTOs to transfer data between the web and the service layer. The changes at web layer are driven by how the user of the service wants to use it while the changes at the service/repository layers are driven by how we do business and how we store data.</p>
</div>
</div>
<div class="sect3">
<h4 id="_domain_objectentity">2.3. Domain Object/Entity</h4>
<div class="paragraph">
<p>For simplicity we will use the following descriptions:</p>
</div>
<div class="sect4">
<h5 id="_domain_object">Domain Object</h5>
<div class="paragraph">
<p>Objects from the business specific area that represent something meaningful to the domain expert.</p>
</div>
</div>
<div class="sect4">
<h5 id="_entity">Entity</h5>
<div class="paragraph">
<p>Domain Object + Identifier</p>
</div>
<div class="paragraph">
<p>We should always try to push business logic inside the Entities when it makes sense. The current rules are the following:</p>
</div>
<div class="paragraph">
<p>Business logic should be part of the entity if:
 - The business logic doesn’t require external services (lazy loading is considered an external service)
 - The business logic only requires the data available in the entity (including nested entities)</p>
</div>
<div class="paragraph">
<p>If the business logic cannot follow those rules, it should live in the service layer.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_always_valid_entity">2.4. Always-Valid Entity</h4>
<div class="paragraph">
<p>When possible, we should try to make our entities always-valid even if it can be tricky with Hibernate.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Throw exception if giving bad data (e.g. mandatory fields)</p>
</li>
<li>
<p>Constructor always leaves the entity in a valid initial state. Sensible default values are provided and constructor allows providing mandatory values. A builder could also be provided.</p>
</li>
<li>
<p>Update entities by a context-specific methods so that they are never in inconsistent states</p>
</li>
<li>
<p>Use private setters if 2 or more fields are linked (e.g. Rectangle, setHeight and setWidth shall be private but setDimension should be public)</p>
</li>
<li>
<p>The validations mentioned above refer to the business definition of valid. The maximum length of a field in the database is not part of the business; this should be handled by the entity validation (see Validation: General Principles section).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_validation_general_principles">2.5. Validation: General Principles</h3>
<div class="sect3">
<h4 id="_dto">2.5.1. DTO</h4>
<div class="paragraph">
<p>Data coming from outside (command-line, web request) should but stored (upon arrival) inside a DTO. The DTO can be transferred to the Service layer where it is validated using Bean Validation annotations. Validation should use the Notification pattern instead of throwing exceptions.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entities">2.5.2. Entities</h4>
<div class="paragraph">
<p>Most of the entities are not a simple data structure; they should have domain-level validation inside them so that they are always-valid. This is more a goal than the current reality.
We should use a Validator based on Bean Validation 2.0 specification to validate the entities using their annotations.</p>
</div>
</div>
<div class="sect3">
<h4 id="_dto_entity_mapping">2.5.3. DTO - Entity Mapping</h4>
<div class="paragraph">
<p>Once we received and validated a DTO, we have to map it to one or more entities. This process could trigger some exception leading to more validation results.</p>
</div>
</div>
<div class="sect3">
<h4 id="_service">2.5.4. Service</h4>
<div class="paragraph">
<p>Dina-base 0.51 onward, we disable the automatic validation and move it to the Service layer where Spring integration is better. As a result, DTOs are no longer validated using Bean Validation annotation, instead they are transferred to the Service layer where they will be validation upon creation/update.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_test_support">3. Test Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>dina-test-support</code> package is a set of utility classes to simplify testing in the different DINA Modules.</p>
</div>
<div class="sect2">
<h3 id="_running_integration_tests_against_a_postgres_docker_container_using_postgrestestcontainerinitializer">3.1. Running integration tests against a Postgres Docker container using PostgresTestContainerInitializer</h3>
<div class="paragraph">
<p>Initializes a Postgres TestContainer if the "embedded.postgresql.enabled" property is true.</p>
</div>
<div class="paragraph">
<p>Use this initializer in integration tests by adding this annotation to your test class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>@ContextConfiguration(initializers = { PostgresTestContainerInitializer.class })</code></pre>
</div>
</div>
<div class="paragraph">
<p>You need to have the correct Spring launch properties set when running tests to enable the Postgres container:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>spring:
  datasource:
    username: web_user
    password: test
  liquibase:
    liquibase-schema: object_store
    user: migration_user
    password: test
embedded.postgresql:
  enabled: true
  image: postgres:10.14
  init-script-file: create-test-users.sql
  database: object_store_test
  schema: object_store</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openapi3assertions">3.2. OpenAPI3Assertions</h3>
<div class="paragraph">
<p><code>OpenAPI3Assertions</code> contains methods to run assertions between an API response and an OpenAPI 3 specification&#8217;s schema. Some of the Open API 3 files could be
stored on remote servers potentially making the tests unstable. When <code>OpenAPI3Assertions.assertRemoteSchema</code> is used, the system property <code>testing.skip-remote-schema-validation</code> can be used to temporarily skip the validation of an API response against a remote schema.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mock_keycloak_user">3.3. Mock Keycloak User</h3>
<div class="paragraph">
<p><code>@WithMockKeycloakUser</code> can be used on a test to have a Keycloak security context created for testing purpose.
For usage see <code>WithMockKeycloakUserIT</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing">4. Testing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Decisions and Guidelines related to testing for the seqdb-api project.
Definitions are based on Testing Concepts.</p>
</div>
<div class="sect2">
<h3 id="_unit_tests">4.1. Unit Tests</h3>
<div class="paragraph">
<p>General Definition: <a href="https://martinfowler.com/bliki/UnitTest.html" class="bare">https://martinfowler.com/bliki/UnitTest.html</a></p>
</div>
<div class="paragraph">
<p>Unit test shall follow the Unit tests naming convention: <code>unitOfWork_StateUnderTest_ExpectedBehavior</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_integration_tests">4.2. Integration Tests</h3>
<div class="paragraph">
<p>General Definition: <a href="https://martinfowler.com/bliki/IntegrationTest.html" class="bare">https://martinfowler.com/bliki/IntegrationTest.html</a></p>
</div>
<div class="paragraph">
<p>Classes shall use the IT suffix. As per <a href="http://maven.apache.org/surefire/maven-failsafe-plugin/examples/inclusion-exclusion.html">Failsafe defaults</a></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authentication">5. Authentication</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_getting_the_current_user">5.1. Getting the current user</h3>
<div class="paragraph">
<p>To get the current user, you can inject a DinaAuthenticatedUser into the constructor:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Named
@Log4j2
public class MyClass {

  private DinaAuthenticatedUser currentUser;

  public MyClass(DinaAuthenticatedUser currentUser) {
    this.currentUser = currentUser;
  }

  public void logCurrentUserName() {
    log.info(currentUser.getUsername());
  }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Event though 'MyClass' is an application-scoped bean, Spring injects a DinaAuthenticaedUser proxy
object that resolves to the actual request-scope DinaAuthenticatedUser bean when DinaAuthenticatedUser&#8217;s
methods are called. So calling logCurrentUserName() will print the currentUser for the current API request.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_a_dev_mode_user_without_needing_to_authenticate_manually">5.2. Using a dev-mode user without needing to authenticate manually</h3>
<div class="paragraph">
<p>To have a 'dev' user set automatically without needing to authenticate via Keycloak token or other
manual method, set these properties:</p>
</div>
<div class="paragraph">
<p><code>keycloak.enabled: false</code> and <code>dev-user.enabled: true</code> (must be set together).</p>
</div>
<div class="paragraph">
<p>If specific group/role is required, use the following config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">dev-user:
  enabled: true
  groupRole :
    aafc :
      - user
    bicoe :
      - read-only</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_your_dina_repo_for_authorization">6. Setting up your Dina Repo for authorization</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_overview">6.1. Overview</h3>
<div class="paragraph">
<p>A dina repository can optionally take a DinaAuthorizationService implementation, which if present will be used to call a set of specific methods for CREATE/READ/UPDATE/DELETE operations.</p>
</div>
<div class="paragraph">
<p>The DinaAuthorizationService is an interface defining the following methods: <em>authorizeCreate, authorizeRead, authorizeUpdate, authorizeDelete</em>.</p>
</div>
<div class="paragraph">
<p>Where each method is called by the dina repo for the appropriate operation on a given entity for that repo&#8217;s domain.</p>
</div>
<div class="paragraph">
<p>Please note that create, update and delete require read access to perform those actions. Read access should be the same or lower than the other operations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_step_by_step_using_a_custom_dina_authorization_service">6.2. Step by Step: Using a custom Dina Authorization Service</h3>
<div class="ulist">
<ul>
<li>
<p>Create your Dina Authorization Service implementation</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Service
@RequiredArgsConstructor
public class CustomAuthorizationService implements DinaAuthorizationService {

  @Inject
  private final Optional&lt;DinaAuthenticatedUser&gt; user;

  @Override
  public void authorizeCreate(Object entity) {
    if (!(user.isPresent()) || !(entity instanceof DinaEntity)) {
      return;
    }

    DinaEntity dinaEntity = (DinaEntity) entity;
    Set&lt;String&gt; userGroups = user.get().getGroups();

    if (CollectionUtils.isEmpty(userGroups) || dinaEntity.getGroup() == null) {
      throw new ForbiddenException("You shall not pass");
    }

    if (userGroups.stream().noneMatch(dinaEntity.getGroup()::equalsIgnoreCase)) {
      throw new ForbiddenException("You shall not pass");
    }
  }

  .....</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Pass your Dina Authorization Service to your Dina Repository</p>
</li>
<li>
<p>Your dina repo will now use your Dina Authorization Service.</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_using_the_default_group_authorization_service">6.2.1. Using the default Group Authorization Service</h4>
<div class="paragraph">
<p>When keycloak is enabled a default Group Authorization Service bean is available in the application context that can be injected into your Dina Repositories</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pass the Group Authorization Service to your Dina Repository</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @Inject
  private Optional&lt;GroupAuthorizationService&gt; groupAuthService;

  @Bean
  public DinaRepository&lt;PersonDTO, Person&gt; dinaRepository() {
    return new DinaRepository&lt;PersonDTO,Person&gt;(
      dinaDatabaseService,
      groupAuthService,

    ....
  }</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Run with <code>keycloak.enabled = true</code></p>
</li>
<li>
<p>Your dina repo will now use the default Group Authorization Service. See GroupAuthorizationService.java.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_returning_your_permissions_for_an_object">6.3. Returning your permissions for an object</h3>
<div class="paragraph">
<p>You can have permissions for three types of operations as evaluated by the dina authorization service.</p>
</div>
<div class="ulist">
<div class="title">Permissions</div>
<ul>
<li>
<p>create</p>
</li>
<li>
<p>read</p>
</li>
<li>
<p>update</p>
</li>
<li>
<p>delete</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When keycloak is enabled you can send a GET request and view your permissions for an object.</p>
</div>
<div class="paragraph">
<p><strong>Step 1 - Setup your resource</strong></p>
</div>
<div class="paragraph">
<p>Your resource DTO must extend the <code>AttributeMetaInfoProvider</code>.</p>
</div>
<div class="listingblock">
<div class="title">Example AttributeMetaInfoProvider</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  public static class ThingDTO extends AttributeMetaInfoProvider {
    @JsonApiId
    private Integer id;
    private UUID uuid;
    private String name;
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Step 2 - Send your request with <code>include-dina-permission</code></strong></p>
</div>
<div class="paragraph">
<p>Send a GET request to a resource and add the Header <code>include-dina-permission</code> to your HTTP request.</p>
</div>
<div class="listingblock">
<div class="title">Example Response</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
   "data":[
      {
         "id":"475c1dc4-99c0-4a56-8177-3f00e4f151e1",
         "type":"person",
         "meta":{
            "permissionsProvider":"SpecialAuthServiceUnderTest",
            "permissions":[
               "create",
               "update"
            ],
            "warnings":null
         },
         "attributes":{
            "name":"jim"
         }
      }
   ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_cors_cross_origin_resource_sharing">7. CORS: Cross-Origin Resource Sharing</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_enabling_cors">7.1. Enabling CORS</h3>
<div class="paragraph">
<p>When a dina-base-api based application is running behind Keycloak, CORS must be enabled through
a Keycloak configuration.</p>
</div>
<div class="paragraph">
<p>In an <code>application.yml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>keycloak.cors: true</code></pre>
</div>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Keycloak&#8217;s CORS support is configured per client. You specify the allowed origins in the client&#8217;s configuration page in the admin console.
You can add as many you want. The value must be what the browser would send as a value in the Origin header.
For example <a href="http://example.com" class="bare">http://example.com</a> is what you must specify to allow CORS requests from example.com. When an access token is created for the client, these allowed origins are
embedded within the token. On authenticated CORS requests, your application&#8217;s Keycloak adapter will handle the CORS protocol and validate the Origin header against
the allowed origins embedded in the token. If there is no match, then the request is denied.</p>
</div>
</blockquote>
<div class="attribution">
&#8212; Keycloak Reference Guide<br>
<cite>Chapter 15.  <a href="https://smartling.github.io/keycloak/docs/1.2.1.Smartling-SNAPSHOT/reference/en-US/html_single/#cors">CORS</a></cite>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_filtering">8. Filtering</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/FilterSpec_Diagram.png" alt="FilterSpec Diagram">
</div>
</div>
<div class="paragraph">
<p>The main component used to represent a filter expression is the <code>FilterExpression</code> class. It consists of an <code>attribute</code>, <code>operator</code>, and <code>value</code> to define the filter condition.</p>
</div>
<div class="paragraph">
<p>A <code>FilterGroup</code> is used to group multiple filter components together and combine them using either the "AND" or "OR" conjunctions.</p>
</div>
<div class="paragraph">
<p>For example, consider the following simple filter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>GET /person?filter[firstName][EQ]=John&amp;filter[lastName][EQ]=Doe</code></pre>
</div>
</div>
<div class="paragraph">
<p>Could be expressed using the following filter components:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">FilterGroup.builder()
  .conjunction(Conjunction.AND)
  .component(new FilterExpression("firstName", Ops.EQ, "John"))
  .component(new FilterExpression("lastName", Ops.EQ, "Doe"))
  .build();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_actuators">9. Actuators</h2>
<div class="sectionbody">
<div class="paragraph">
<p>DINA modules can be configured to expose <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html">Spring Actuators</a>.</p>
</div>
<div class="paragraph">
<p>In the module <code>application.yml</code> or using environment variables:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Change <code>security-collections.patterns</code> to <code>/api/*</code> to tell Keycloak adapter to only filter on <code>/api</code> and leave other requests to the other filters in the chain.</p>
</li>
<li>
<p>Add <code>actuator.allowedIp</code> to define the IPs that are allowed to access the actuators. Network mask should limit to internal IPs but cautions should be taken when an external request is routed by a Gateway/Reverse-Proxy.
Depending on the settings, the module could see the request as coming from the internal network. In Docker-Compose, the name of the container can be used to restrict the IP to the Prometheus container for example.</p>
</li>
<li>
<p>Add <code>management.endpoints.web.exposure.include: "health,prometheus"</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then, a Prometheus container can be configured to connect to the <code>/actuator/prometheus</code> endpoint of a module.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_messaging">10. Messaging</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_message_procucer">10.1. Message procucer</h3>
<div class="paragraph">
<p>Declare a <code>RabbitMQQueueProperties</code> and <code>RabbitMQMessageProducer</code> based beans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@ConfigurationProperties(prefix = "dina.messaging.export")
@Component
@Named("theQueueProperties")
public class TheQueueProperties extends RabbitMQQueueProperties {
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Log4j2
@Service
@ConditionalOnProperty(prefix = "dina.messaging", name = "isProducer", havingValue = "true")
public class MyDinaMessageProducer extends RabbitMQMessageProducer implements DinaMessageProducer {

  public RabbitMQDinaMessageProducer(RabbitTemplate rabbitTemplate, TheQueueProperties queueProperties) {
    super(rabbitTemplate, queueProperties);
    log.info( "Using RabbitMQ queue {}", queueProperties::getQueue);
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For search related messaging, implement <code>DocumentOperationNotificationMessageProducer</code> instead of the more generic <code>DinaMessageProducer</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_message_consumer">10.2. Message consumer</h3>
<div class="paragraph">
<p>Declare a <code>RabbitMQQueueProperties</code> and <code>RabbitMQConsumerConfiguration</code> based beans.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Configuration
@ConditionalOnProperty(prefix = "dina.messaging", name = "isConsumer", havingValue = "true")
public class TheQueueConsumerConfiguration extends RabbitMQConsumerConfiguration {

  public ObjectExportQueueConsumerConfiguration(@Named("exportQueueProperties")
                                                TheQueueProperties queueProperties) {
    super(queueProperties);
  }

  @Bean("theQueue")
  @Override
  public Queue createQueue() {
    return super.createQueue();
  }

  @Bean("theDeadLetterQueue")
  @Override
  public Queue createDeadLetterQueue() {
    return super.createDeadLetterQueue();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then on the consumer class you can use <code>@RabbitListener(queues = "#{theQueueProperties.getQueue()}")</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation">11. Validation</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_the_principles">11.1. The Principles</h3>
<div class="paragraph">
<p>From dina-base 0.51 onward, we disable the automatic validation and move it to the Service layer where Spring integration is better.</p>
</div>
<div class="paragraph">
<p>Before dina-base was mostly relying on JPA level validation which worked for most application but can be difficult when we need customization (internationalization and localization) or custom validations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementation">11.2. Implementation</h3>
<div class="paragraph">
<p>Validation is done at the Service level and is automatically handled by <code>DefaultDinaService</code>.</p>
</div>
<div class="paragraph">
<p>There is 2 types of validation at the Service level :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Constraints validation (automatic checks that will use the constraint annotations on the Entity)</p>
</li>
<li>
<p>Business rule(s) validation (must be implemented by the concrete Service by overriding the <code>validateBusinessRules</code> method)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Constraint validation also supports validation group <code>OnCreate</code> and <code>OnUpdate</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_validation_endpoint">12. Validation Endpoint</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_set_the_configuration_properties">12.1. Set the configuration properties</h3>
<div class="paragraph">
<p>To activate the validation endpoint, the configuration property <code>dina.validationEndpoint.enabled: true</code> will need to be added to the application.yml.</p>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_validation_resource_configuration">12.2. Create a Validation Resource Configuration</h3>
<div class="paragraph">
<p>You will need to create a component implementing the <code>ValidationResourceConfiguration</code> interface to supply the validation endpoint with the appropriate types to validate.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_endpoint">12.3. Using the Endpoint</h3>
<div class="paragraph">
<p>When the application starts you will have access to the validation endpoint at <code>/validation</code>.</p>
</div>
<div class="paragraph">
<p>You can send a request to validate the attributes of a resource.</p>
</div>
<div class="listingblock">
<div class="title">Example Request Body</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
  "data": {
    "attributes": {
      "type": "validation",
      "data": {
        "type": "chain",
        "attributes": {
          "group": "d",
          "name": "name"
        },
        "relationships": {
          "chainTemplate": {
            "data": {
              "id": "1",
              "type": "chainTemplate"
            }
          }
        }
      }
    }
  }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Response Headers</div>
<div class="content">
<pre class="highlight"><code>HTTP/1.1 201
Content-Type: application/vnd.api+json;charset=utf-8
Content-Length: 255
Date: Thu, 13 May 2021 15:10:35 GMT
Keep-Alive: timeout=60
Connection: keep-alive</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example Response Body</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "data": {
        "id": "N/A",
        "type": "validation",
        "links": {
            "self": "http://localhost:35227/validation/N/A"
        },
        "attributes": {
            "type": "chain",
            "data": {
                "relationships": {
                    "chainTemplate": {
                        "data": {
                            "id": "1",
                            "type": "chainTemplate"
                        }
                    }
                },
                "attributes": {
                    "group": "d",
                    "name": "name"
                }
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Example failed Validation</div>
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">{
    "errors": [
        {
            "status": "422",
            "title": "Validation error",
            "detail": "size must be between 1 and 50"
        }
    ]
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auditing">13. Auditing</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://javers.org/">JaVers</a> is used to save snapshots of DTOs on create, update and delete events.</p>
</div>
<div class="sect2">
<h3 id="_setting_up_your_dina_repo_for_auditing">13.1. Setting up your Dina Repo for auditing</h3>
<div class="paragraph">
<p>dina-base does not manage the database schema for auditing. The responsibility belongs to the specific module.</p>
</div>
</div>
<div class="sect2">
<h3 id="_prepare_your_dto">13.2. Prepare your DTO</h3>
<div class="paragraph">
<p>Your DTO must be prepared with specific annotations specifically @TypeName, @Id, @PropertyName.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Add the Javers annotations to the DTO:</p>
<div class="ulist">
<ul>
<li>
<p>@TypeName should be added to the class for JaVers to know the type.</p>
</li>
<li>
<p>@Id and @PropertyName("id") should be added to the ID field, which JaVers uses to track multiple versions of
the same entity.</p>
</li>
<li>
<p>@ShallowReference should be added to relation fields (along with Crnk&#8217;s @JsonApiRelation).
This prevents a problem where the referenced resource is re-audited with all fields null.</p>
</li>
<li>
<p>@Value should be added to embedded objects, like other DTOs that are considered values of a parent DTO.
e.g. "AddressDto" is an embedded Value in "PersonDto", not a standalone entity.</p>
<div class="ulist">
<ul>
<li>
<p>When a child value
is changed, the parent object should also be updated (via timestamp update). This can be done using
@PrePersist, @PreUpdate and @PreDelete annotations on the JPA Entity.</p>
</li>
<li>
<p>Child values should not be audited separately, regardless of database structure.</p>
</li>
</ul>
</div>
</li>
<li>
<p>@DiffIgnore should be added to any fields not needed in the snapshots, like derived DTO fields.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Check out the supported annotations <a href="https://javers.org/documentation/domain-configuration/#supported-annotations">HERE</a> for more details on how you can configure your domain.</p>
</div>
</div>
<div class="sect2">
<h3 id="_pass_the_auditing_service_bean_to_your_dina_repo">13.3. Pass the Auditing service bean to your Dina repo</h3>
<div class="paragraph">
<p>When the application runs with the property <code>dina.auditing.enabled = true</code>, an AuditService bean is available in the application context.</p>
</div>
<div class="paragraph">
<p>Simply pass this bean to your dina repository and auditing will be enabled for CREATE/DELETE/UPDATE operations.</p>
</div>
</div>
<div class="sect2">
<h3 id="_accessing_the_auditing_endpoint">13.4. Accessing the Auditing Endpoint</h3>
<div class="paragraph">
<p>When the application runs with the property <code>dina.auditing.enabled = true</code>, the audit endpoint automatically starts.</p>
</div>
<div class="paragraph">
<p>JSONAPI endpoint at /audit-snapshot , implemented by the AuditSnapshotRepository class.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Page results using query parameters page[limit] and page[offset].</p>
</li>
<li>
<p>Filter the results:</p>
<div class="ulist">
<ul>
<li>
<p>By author: <code>filter[author]=authorname</code></p>
</li>
<li>
<p>By instance: <code>filter[instanceId]=metadata/0fc10c52-91b6-4a9b-be98-e3f75b9928f7</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lazy_logging">14. Lazy Logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We can avoid the calculation of log messages for log levels that are not enabled through the use of lazy logging.</p>
</div>
<div class="paragraph">
<p>To do so we use lambda expressions inside the logging statements available in <a href="https://logging.apache.org/log4j/2.x/">Log4j 2</a>.</p>
</div>
<div class="listingblock">
<div class="title">Normal statement</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">logger.trace("Output: {}", getExpensiveOperation());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Lazy Logging statement</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">log.trace("Output: {}", () -&gt; getExpensiveOperation());</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Lazy Logging statement with multiple lambdas</div>
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">log.trace("Name is {} and age is {}", () -&gt; getName(), () -&gt; getRandomNumber());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The lambda expression is only evaluated if the corresponding log level is enabled.</p>
</div>
<div class="paragraph">
<p>See <a href="https://www.baeldung.com/log4j-2-lazy-logging"> This Guide</a> for more information.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_external_types_guide">15. External Types Guide</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_set_up_your_entity">15.1. Set up your entity</h3>
<div class="paragraph">
<p>Your entity needs to hold the identifier of the resource in a field.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  private UUID acMetaDataCreator;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_your_dto">15.2. Set up your DTO</h3>
<div class="paragraph">
<p>Your Dto needs to declare the type of the field as a <code>ExternalRelationDto</code> and provide the needed annotations. The <code>JsonApiExternalRelation</code> type is the name of the resource type.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @JsonApiExternalRelation(type = "agent")
  @JsonApiRelation
  private ExternalRelationDto acMetaDataCreator;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_set_up_your_external_resource_provider_component">15.3. Set up your External Resource Provider Component</h3>
<div class="paragraph">
<p>You need to create a component implementing an <code>ExternalResourceProvider</code>. A simple example would look like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Component
public class ExternalResourceProviderImplementation implements ExternalResourceProvider {

  public static final Map&lt;String, String&gt; typeToReferenceMap = ImmutableMap.of(
    "agent", "Agent/api/v1/agent");

  @Override
  public String getReferenceForType(String type) {
    return typeToReferenceMap.get(type);
  }

  @Override
  public Set&lt;String&gt; getTypes() {
    return typeToReferenceMap.keySet();
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, you need to pass your <code>ExternalResourceProvider</code> to your <code>DinaRepo</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java"> public DinaRepository&lt;ProjectDTO, Project&gt; projectRepo(
      BaseDAO baseDAO,
      DinaFilterResolver filterResolver,
      ExternalResourceProvider externalResourceProvider
    ) {
      return new DinaRepository&lt;&gt;(
        ...
        externalResourceProvider
      );</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_releasing_dina_base_api">16. Releasing dina-base-api</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The process of releasing dina-base-api is partially automated.</p>
</div>
<div class="paragraph">
<p>To initiate the process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From dev branch</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change the version by running <code>mvn versions:set -DnewVersion=X.X</code> from the root where <code>X.X</code> is the current version minus the <code>-SNAPSHOT</code></p>
</li>
<li>
<p>Add and Push to dev with message like "Prepare version x.x release"</p>
</li>
<li>
<p>Wait for CI to complete</p>
</li>
</ol>
</div>
</li>
<li>
<p>From master</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Merge dev into master (do NOT use Pull Request)</p>
</li>
<li>
<p>Push to master (it will trigger the deployment to the staging repository of Maven Central)</p>
</li>
</ol>
</div>
</li>
<li>
<p>Create a new <a href="https://github.com/AAFC-BICoE/dina-base-api/releases">GitHub release</a></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Add a Summary of the changes (looks at the previous versions for an example)</p>
</li>
<li>
<p>Publish the Release</p>
</li>
</ol>
</div>
</li>
<li>
<p>From dev branch</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Change the version by running <code>mvn versions:set -DnewVersion=X.X-SNAPSHOT</code> from the root where X.X is the next increment in the version number</p>
</li>
<li>
<p>Add and Push to dev with message like "Prepare next development version"</p>
</li>
</ol>
</div>
</li>
<li>
<p>Release the artifact to Maven Central</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Login to <a href="https://oss.sonatype.org/" class="bare">https://oss.sonatype.org/</a></p>
</li>
<li>
<p>Close the release from staging repository</p>
</li>
<li>
<p>Release the artifact</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_field_adapters">17. Field adapters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Field adapters allow you to provide custom mappings between fields.</p>
</div>
<div class="paragraph">
<p>We have a field in a DTO that is of type Integer that we want to map between an entity where the field is of type string.</p>
</div>
<div class="paragraph">
<p>We will need to provide a custom mapping.</p>
</div>
<div class="sect2">
<h3 id="_implement_a_dina_field_adapter_for_the_field">17.1. Implement a Dina Field Adapter for the field.</h3>
<div class="paragraph">
<p>Example Implementation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">class CustomFieldAdapterImpl implements DinaFieldAdapter&lt;CarDto, Car, Integer, String&gt; {

    //No args constructor required
    public CustomFieldAdapterImpl() {
    }

    @Override
    public Integer toDTO(String s) {
      return Integer.valueOf(s);
    }

    @Override
    public String toEntity(Integer integer) {
      return Integer.toString(integer);
    }

    @Override
    public Consumer&lt;String&gt; entityApplyMethod(Car dtoRef) {
      return dtoRef::setCustomField;
    }

    @Override
    public Consumer&lt;Integer&gt; dtoApplyMethod(CarDto entityRef) {
      return entityRef::setCustomField;
    }
  }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>toDTO</code> and <code>toEntity</code> methods provide the logic to convert the field value from DTO to Entity and vice versa. The <code>entityApplyMethod</code> and <code>dtoApplyMethod</code> methods allow you to supply the method that will apply the converted values to the appropriate field. In this example we use the base Setters as the methods that will apply the converted values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_annotate_your_field_with_ignoredinamapping">17.2. Annotate your field with IgnoreDinaMapping</h3>
<div class="ulist">
<ul>
<li>
<p>Mark your field in your DTO with the <code>IgnoreDinaMapping</code> annotation.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @IgnoreDinaMapping(reason = "Custom resolved field")
    private String customField;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_annotate_your_class_with_customfieldadapter">17.3. Annotate your class with CustomFieldAdapter</h3>
<div class="ulist">
<ul>
<li>
<p>Mark your DTO with the <code>CustomFieldAdapter</code> annotation and give it the adapter you created in step one.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  @CustomFieldAdapter(adapters = CustomFieldAdapterImp.class)
  public static final class StudentDto {</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_custom_rsql_filtering">18. Custom Rsql Filtering</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_current_specs">18.1. Current Specs</h3>
<div class="paragraph">
<p>You can add custom rsql filtering for your resource in order to manipulate how Rsql filters will be processed.</p>
</div>
<div class="sect3">
<h4 id="_step_1_create_a_rsqlfilteradapter_for_your_class">18.1.1. Step 1: Create a RsqlFilterAdapter for your class.</h4>
<div class="paragraph">
<p>This is a simple Functional interface which will provide the entry point to run your business logic to process the Rsql filters.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Node process(Node node);</pre>
</div>
</div>
<div class="paragraph">
<p>The process method will receive the root node of the rsql filters and will return the final rsql node to be used in the filtering process.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_2_pass_your_filter_adapter_to_the_dina_filter_resolver">18.1.2. Step 2: Pass your filter adapter to the Dina filter resolver.</h4>
<div class="paragraph">
<p>The DinaFilterResolver will allow you to pass your adapter to the resolver in the constructor.</p>
</div>
<div class="paragraph">
<p>You can do this during the creation of your repository for the resource.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>DinaFilterResolver(RsqlFilterAdapter rsqlFilterAdapter)</pre>
</div>
</div>
<hr>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_one_to_many_associations">19. One to Many Associations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There is some common functionality the currently needs to be run to resolve associations between child and parent resources.</p>
</div>
<div class="paragraph">
<p>This documentation will provide the current strategies used in dina base to help resolve child/parent associations.</p>
</div>
<div class="paragraph">
<p>Basic information around Hibernates requirements for Bi directional associations : <a href="https://vladmihalcea.com/the-best-way-to-map-a-onetomany-association-with-jpa-and-hibernate/">Article</a></p>
</div>
<div class="sect2">
<h3 id="_using_the_onetomanydinaservice">19.1. Using the OneToManyDinaService</h3>
<div class="paragraph">
<p>The simplest way would be to extend the OneToManyDinaService. After extending a OneToManyDinaService, the constructor will require you to supply a list of OneToManyFieldHandler as shown in the example service below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">    @Service
    public static class ParentService extends OneToManyDinaService&lt;Parent&gt; {

      public ParentService(
        @NonNull BaseDAO baseDAO,
        @NonNull SmartValidator validator
      ) {
        super(baseDAO, validator,
          List.of(
            new OneToManyFieldHandler&lt;&gt;(
              Child.class, // Class type of the child resource
              child -&gt; child::setParent, // Method to apply the parent to the child
              Parent::getChildren, // Method to supply the children from the parent
              "parent", // field name of the parent on the child class
              child -&gt; child.setParent(null)))); // Method to handle orphaned children of the parent resource
      }

      @Override
      protected void preCreate(Parent entity) {
        entity.setUuid(UUID.randomUUID());
      }

    }</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_onetomanyfieldhandler_directly">19.2. Using OneToManyFieldHandler directly</h3>
<div class="paragraph">
<p>OneToManyFieldHandlers can handle parent/child associations for a single field.</p>
</div>
<div class="paragraph">
<p>If you cannot extend the OneToManyDinaService or need to handle associations outside of this class, you can always use the OneToManyFieldHandlers directly.</p>
</div>
<div class="paragraph">
<p>After creating the OneToManyFieldHandler for a single field, 3 methods will be provided to allow you to resolve associations for common create/update/delete operations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">  public void onCreate(P parent)

  public void onUpdate(P parent, DinaService&lt;?&gt; dinaService)

  public void onDelete(P parent)</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-06-28 14:14:34 UTC
</div>
</div>
</body>
</html>